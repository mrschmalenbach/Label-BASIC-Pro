REM good_all_features_task_queue.lbp
REM Mix: REPEAT/UNTIL, EXIT/CONTINUE, enums, constants, options

REM ##OPTION STRICT_ERR ON
REM ##OPTION DEFINE ON
REM ##OPTION REMPASS ON

REM -----------------------------------------
REM CONSTANTS & ENUMS
REM -----------------------------------------

CONSTANT MAX_TASKS% = 6

ENUM TASK_TYPES
TASK_NONE
TASK_IO
TASK_COMPUTE
TASK_MAINT
END ENUM

REM -----------------------------------------
REM SIMPLE TASK ARRAYS
REM -----------------------------------------

DIM TASK.TYPE%(MAX_TASKS%)
DIM TASK.WEIGHT%(MAX_TASKS%)

I% = 1
WHILE I%<=MAX_TASKS%
  TASK.TYPE%(I%) = TASK_NONE
  TASK.WEIGHT%(I%) = 0
  I% = I% + 1
WEND

REM Seed a few tasks
TASK.TYPE%(1) = TASK_IO
TASK.WEIGHT%(1) = 2

TASK.TYPE%(2) = TASK_COMPUTE
TASK.WEIGHT%(2) = 5

TASK.TYPE%(3) = TASK_MAINT
TASK.WEIGHT%(3) = 3

TASK.TYPE%(4) = TASK_COMPUTE
TASK.WEIGHT%(4) = 1

PRINT "STARTING TASK QUEUE DEMO..."
PRINT "MAX_TASKS=";MAX_TASKS%

REM -----------------------------------------
REM PROCESS LOOP
REM -----------------------------------------

INDEX% = 1
PROCESSED% = 0

REPEAT
  IF INDEX%>MAX_TASKS% THEN
    PRINT "NO MORE TASK SLOTS."
    EXIT REPEAT
  END IF

  TTYPE% = TASK.TYPE%(INDEX%)
  TWEIGHT% = TASK.WEIGHT%(INDEX%)

  IF TTYPE%=TASK_NONE THEN
    PRINT "SLOT";INDEX%;" EMPTY - CONTINUE REPEAT"
    INDEX% = INDEX% + 1
    CONTINUE REPEAT
  END IF

  PRINT
  PRINT "PROCESSING SLOT";INDEX%;
  PRINT "  TYPE=";TTYPE%;" WEIGHT=";TWEIGHT%

  REM Simple type-based handling
  IF TTYPE%=TASK_IO THEN
    PRINT "  -> IO TASK"
  ELSE
    IF TTYPE%=TASK_COMPUTE THEN
      PRINT "  -> COMPUTE TASK"
    ELSE
      IF TTYPE%=TASK_MAINT THEN
        PRINT "  -> MAINTENANCE TASK"
      ELSE
        PRINT "  -> UNKNOWN TASK TYPE"
      END IF
    END IF
  END IF

  PROCESSED% = PROCESSED% + 1

  REM Mark as done
  TASK.TYPE%(INDEX%) = TASK_NONE
  TASK.WEIGHT%(INDEX%) = 0

  INDEX% = INDEX% + 1

UNTIL PROCESSED%>=3

PRINT
PRINT "TASK QUEUE DEMO COMPLETE."
PRINT "TOTAL PROCESSED=";PROCESSED%
